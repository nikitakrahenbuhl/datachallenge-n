---
title: How are deer affected by recreational activities
subtitle: Computational Movement Analysis
author: Nikita Krähenbühl
output: html_document
---

```{r include=FALSE}
rm(list=ls())

library(tidyverse)
library(sf)
library(tmap)
library(lubridate)
library(ggplot2)
library(RColorBrewer)
library(ggpubr)
library(plotly)
library(multcomp)

theme_set(theme_classic())

options(warning=FALSE)    # Don't show warnings
```

# To does
Monday
-   Filter deer data

    -   1-2 deers

    -   Summer and Winter of one year

    -   Differing sample rate

        -   3 hour for weekend vs weekday comparison

        -   5 minute for daily rhythms

        -   for avoidance of routes/crossing use the 5 minute limit
- To do on Tuesday 
- decide what method to use for crossing

## Abstract

## Introduction

In addition to being the main habitat of European roe deer (Capreolus capreolus), forests provide diverse and outstanding settings for recreational activities such as hiking, horse riding and mountain biking (Jacsman, 1990)

The following hypotheses are therefore being tested:

| Null hypothesis                                           | Alternate hypothesis                                  |
|-----------------------------------------------------------|-------------------------------------------------------|
| Deer movement does not vary between weekdays and weekend  | Deer movement on average increases during the weekend |
| Dear movement is not constrained by recreational activity | Deer movement is constrained by activity              |
|                                                           |                                                       |
|                                                           |                                                       |
|                                                           |                                                       |

: Hypotheses

## Material and Methods

### Datasets

```{r}
deer <- read_csv("data/all_deer_cleaned.csv")
deer %>% 
  group_by(reh) %>% 
  summarise(n = n())

summary(deer)
str(deer)
```

The deer dataset was provided from a multi-year (2014-2016) research project conducted in partnership with the Wildnispark Sihlwald. The Wildnispark Zurich consists of a protected core area and a surrounding area with high recreational use due to its proximity to the city of Zurich. The dataset tracks the movement of 14 deer using GPS trackers. Each fix point in the dataset contains the following attributes:

| Name      | Units   | Purpose                      |
|-----------|---------|------------------------------|
| Latitude  | Degrees | Positioning data             |
| Longitude | Degrees | Positioning data             |
| x         |         | Positioning data (projected) |
| y         |         | Positioning data (projected) |
| reh       |         | ID of individual             |
| datetime  |         | Time                         |

: Data strucutre

The characteristics of the data limit the computational movement analysis methods that can be applied.

| Col1 | Col2 | Col3 | Col4 |
|------|------|------|------|
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |
|      |      |      |      |

Activity data from Strava was gathered by analysing the publicly available [global heatmap](https://www.strava.com/heatmap) using a script provided by Nils Ratnaweera. Colour values from the raster data are used to indicate the number of activities was converted into . This provides a relative indication of how often a route is frequented. Whilst all activity types (cycling, running etc.) were gathered, the dataset does not allow for differentiation between activities and contains no temporal data.

Street and hiking path data was sourced from swisstopo.

### Preprocessing

```{r}
## Relevant functions
rle_id <- function(vec){
  x <- rle(vec)$lengths
  as.factor(rep(seq_along(x), times=x))
}

## lets assign some useful, basic movement parameters
speed_calculator <- function(df_input){
  df_input %>% 
    group_by(reh) %>% 
    mutate(timelag = as.integer(difftime(lead(datetime_utc), datetime_utc, units = "secs")), 
           steplength = sqrt((y - lead(y,1))^2 + (x - lead(x,1))^2),
           timelag_minutes = timelag/60,
         speed_ms = steplength/timelag,
         speed_kph = speed_ms * 3.6) -> df_output
  
  return(df_output)
} 

## Static points¨
step_calculator <- function(df_input){
    mutate(
      nMinus3 = sqrt((lag(y, 3)-y)^2 + (lag(x, 3)-x)^2),
      nMinus2 = sqrt((lag(y, 2)-y)^2+(lag(x, 2)-x)^2),  
      nMinus1 = sqrt((lag(y, 1)-y)^2+(lag(x, 1)-x)^2),
      nPlus1  = sqrt((y-lead(y, 1))^2+(x-lead(x, 1))^2), 
      nPlus2  = sqrt((y-lead(y, 2))^2+(x-lead(x, 2))^2),  
      nPlus3  = sqrt((y-lead(y, 3))^2+(x-lead(x, 3))^2)) %>% 
  rowwise(.) %>% 
  mutate(
    stepMean = mean(c(nMinus3, nMinus2, nMinus1, nPlus1, nPlus2, nPlus3))) %>% 
  ungroup() %>% 
  mutate(static = stepMean < mean(stepMean, na.rm = TRUE)) -> df_output
  
  return(df_output)
  
}
```

#### Deer Data

```{r}
## Reading geometry, setting LV95 as coordinates 
## Getting weekdays, timelag, stepMean and Speed data
deer %>% 
  st_as_sf(., coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(., crs = 2056) %>% 
  mutate(x = unlist(map(.$geometry,1)),
       y = unlist(map(.$geometry,2))) %>% 
  mutate(wdays = lubridate::wday(datetime_utc, label = TRUE), 
         week_start = getOption("lubridate.week.start", -1),
         month = factor(format(datetime_utc,"%B"), levels = month.name), 
         year = format(datetime_utc, "%Y")) %>% 
  speed_calculator(.)-> deer
```

#### Context

```{r}
### Need to load the street/hiking data
# First create a polygon with bounding boc
x_coord <- c( 2679000, 2687981, 2687981, 2679000)
y_coord <- c(1241000, 1241000, 1228484, 1228484)
xym <- cbind(x_coord, y_coord)
library(sp)
p = Polygon(xym)
ps = Polygons(list(p),1)
sps = SpatialPolygons(list(ps))

strassen <- read_sf("/Users/nikitakrahenbuhl/Documents/Masters/PandT/project/datachallenge-n/data/swiss_TLM_data.gpkg","strassen")
boden <- read_sf("/Users/nikitakrahenbuhl/Documents/Masters/PandT/project/datachallenge-n/data/swiss_TLM_data.gpkg","bodenbedeckung")

strassen %>% filter(grepl("Weg|Autobahn|3m Strasse", OBJEKTART))  -> strassen_freizeit
strassen %>% filter(!is.na(WANDERWEGE)) -> wanderwege
```

#### Strava

```{r}
source("strava.R")
#strava_get(zoom = 11)
library(terra)
strava <- rast("strava_all_11_hot/combined/05_cropped.tif") %>% crop(., sps)

plot(strava)
```



### Exploratory analysis and filtering

```{r}
## Temporal overview
ggplot(data = deer, aes(x = datetime_utc, y = reh)) +
  geom_line() 

## Sampling schedule
ggplot(deer) + geom_boxplot(aes(x=reh, y=timelag_minutes))
ggplot(deer) + geom_histogram(aes(x=timelag_minutes), bins = 200) 
ggplot(deer) + geom_boxplot(aes(x=reh, y=steplength))
ggplot(deer) + geom_histogram(aes(x=steplength), bins = 100)

ggplot(deer, aes(x=datetime_utc, y = timelag_minutes, color = reh)) + geom_line() + facet_wrap(~reh)

## Initial spatial exploration
deer %>% 
  group_by(reh) %>% 
  summarise(.) %>% 
  st_convex_hull(.) -> mcp

tmap_mode("view") 
tm_shape(mcp) + tm_polygons("reh", alpha = 0.4) +
tm_shape(wanderwege) + tm_lines(col = "tomato3") 

```

Multiple sampling regimes, in intervals of 180 and 5 minutes were used. This data was consequently split, with long sampling intervals used to examine variations within a week. The shorter sampling intervals were used to analyse daily variations in movement and interactions with recreational infrastructure. There are clearly some temporal outliers, which were removed by sampling +- 2 minutes of the identified sampling intervals. Spatial outliers were roughly removed by filtering the data to a steplength of less than 2500 meters.

Due to the large amount of deer groups and temporal timescale a subset of deer groups must be chosen that interact with recreational infrastructure, are independent and contain concurrently recorded GPS tracks.

was chosen for analysis, as they are fairly dispersed and interact with recreational infrastructure. The multi-annual sampling period was also reduced to 2014, as there was continuous and well-sampled data for the chosen deer groups.

```{r}
## Are some deer on average more active (disturbed) than others
deer %>% 
  st_drop_geometry() %>% 
  filter(between(timelag_minutes, 178, 182) & steplength < 2500 & year == 2014) %>% 
  group_by(reh) %>% summarise(avg_steplength_long = mean(steplength)) -> df

deer %>% 
  st_drop_geometry() %>% 
  filter(between(timelag_minutes,  3, 7) & steplength < 2500 & year == 2014) %>% 
  group_by(reh) %>% summarise(avg_steplength_short = mean(steplength)) -> df1

merge(df, df1) -> df2

active_deer <- c("RE15", "RE08", "RE11", "RE06")
#active_deer <- c("RE06")

deer %>% 
  filter(between(timelag_minutes, 178, 182) & 
           steplength < 2500 & 
           reh %in% active_deer &
           year == 2014) -> deer_long

deer_long %>% 
  ggplot(., aes(x=x, y=y, color=reh)) + geom_path() + geom_point() +
  coord_fixed()

deer_long %>% 
  st_drop_geometry(.) %>% 
  mutate(month = format(datetime_utc,"%m"), year = format(datetime_utc, "%Y")) %>% 
  group_by(reh, year, month, wdays) %>% 
  summarise(mean_steplength = mean(steplength), mean_speed = mean(speed_ms), n=n()) %>% 
  ggplot() + geom_tile(aes(x=wdays, y = month, fill = n)) + facet_grid(reh~year) 


deer %>% 
  mutate(year = format(datetime_utc, "%Y")) %>% 
  filter(between(timelag_minutes, 3, 7) & 
           steplength < 2500 &
           reh %in% active_deer &
           year == 2014) -> deer_short

deer_short %>% 
  ggplot(., aes(x=x, y=y, color=reh)) + geom_path() + geom_point() +
  coord_fixed()

deer_short %>% 
  st_drop_geometry(.) %>%
  mutate(month = format(datetime_utc,"%m"), year = format(datetime_utc, "%Y")) %>% 
  group_by(reh, year, month, wdays) %>% 
  summarise(mean_steplength = mean(steplength), mean_speed = mean(speed_ms), n=n()) %>% 
  ggplot() + geom_tile(aes(x=wdays, y = month, fill = n)) + facet_grid(reh~year) 
```

A subset of data was defined.



### Comparing weekdays and weekends

GPS Tracks for deer was

How did I handle outliers?

Now lets have a look at visual variant

Would be really interesting to calculate steplength or speed within a day and then split it up by day of the week

```{r}
deer_long %>% 
  st_drop_geometry() %>% 
  group_by(reh, month, wdays) %>% 
  summarise(avg_steplength = mean(steplength, na.rm = TRUE)) %>% 
  ggplot(., aes(x=wdays, y = avg_steplength)) + geom_bar(stat="identity", position = position_dodge(),  width=.5) 

deer_long %>% 
  st_drop_geometry() %>% 
  group_by(reh, month, wdays) %>% 
  summarise(avg_steplength = mean(steplength, na.rm = TRUE)) %>% 
  ggplot(., aes(x=wdays, y = avg_steplength)) + geom_bar(stat="identity", position = position_dodge(),  width=.5) + facet_wrap(~month)

deer_long %>% 
  st_drop_geometry() %>% 
  mutate(hour = hour(round_date(datetime_utc, "hour"))) %>% 
  group_by(reh, month, wdays, hour) %>% 
  summarise(avg_steplength = mean(steplength, na.rm = TRUE)) %>% 
  ggplot(., aes(x = hour, y = avg_steplength, color = reh)) + geom_line() + geom_point() + facet_grid(month~wdays)

deer %>% 
  mutate(hour = hour(round_date(datetime_utc, "hour"))) %>% 
  group_by(reh, wdays, hour) %>% 
  summarise(mean_steplength = mean(steplength), mean_speed = mean(speed_kph)) %>% 
  ggplot(data = ., aes(x=hour, y=mean_steplength, color = reh))  + geom_line() + facet_wrap(~wdays)

deer_short %>% 
  group_by(reh, wdays) %>% summarise(mean_steplength = mean(steplength)) %>% 
  ggplot(data = ., aes(x=wdays, y=mean_steplength, color = reh)) + geom_line() + geom_point() 
```

Statistical Variant

```{r}
deer %>% 
  ggplot(.) + geom_boxplot(aes(x=wdays, y = log(steplength)))

deer %>% drop_na(steplength) %>% filter(between(steplength, 1, 3000)) %>% 
  aov(log(steplength) ~ wdays, data = .) -> aov1

plot(aov1)
summary(aov1)

tk_hsd <- TukeyHSD(aov1)
library(multcompView)

names <- names(tk_hsd)
p_vals <- extract_p(tk_hsd)

multcompLetters(unlist(p_vals))
```

#### Examining whether movement is constrained by recreational infrastructure

```{r}

pdf()
ggplot() + 
  geom_sf(data = boden, aes(fill = OBJEKTART)) + scale_fill_brewer(palette="Dark2") +
  geom_sf(data = strassen %>% filter(!is.na(WANDERWEGE)), color = "red") +
  geom_sf(data = deer, aes(color=reh))
dev.off()

```

Now adding the strava data

```{r}
terra::extract(strava, vect(wanderwege), fun=mean) %>% 
  cbind(wanderwege, .) %>% 
  st_as_sf(.) %>% rename(popularity = X01_combined) -> wanderwege


wanderwege %>% st_buffer(5) -> wanderwege5
wanderwege %>% st_buffer(10) -> wanderwege10
wanderwege %>% st_buffer(30) -> wanderwege30

tmap_mode("view") 
tm_shape(mcp) + tm_polygons("reh", alpha = 0.4) +
tm_shape(wanderwege30) + tm_polygons(col = "popularity") 

wanderwege %>% filter(popularity > 125) %>% 
  ggplot(.) + geom_sf(aes(color = popularity))


```

Lets only examine RE06 for this initially. We could

```{r}
deer_short %>% 
  filter(reh == "RE06") %>% mutate(month = ymd(datetime_utc)) %>% 
  group_by(month) %>% 
      mutate(
      nMinus3 = sqrt((lag(y, 3)-y)^2 + (lag(x, 3)-x)^2),
      nMinus2 = sqrt((lag(y, 2)-y)^2+(lag(x, 2)-x)^2),  
      nMinus1 = sqrt((lag(y, 1)-y)^2+(lag(x, 1)-x)^2),
      nPlus1  = sqrt((y-lead(y, 1))^2+(x-lead(x, 1))^2), 
      nPlus2  = sqrt((y-lead(y, 2))^2+(x-lead(x, 2))^2),  
      nPlus3  = sqrt((y-lead(y, 3))^2+(x-lead(x, 3))^2)) %>% 
  rowwise(.) %>% 
  mutate(
    stepMean = mean(c(nMinus3, nMinus2, nMinus1, nPlus1, nPlus2, nPlus3))) %>% 
  ungroup() %>% 
  mutate(static = stepMean < mean(stepMean, na.rm = TRUE)) -> re06

  ggplot(data = re06, aes(x = x, y = y)) +
    geom_point(aes(color = static)) +
    coord_fixed() + labs(title = "All static points removed")
  
  re06 %>%
  mutate(segment_id = rle_id(static),
         duration = as.integer(difftime(max(datetime_utc),min(datetime_utc), units = "mins"))) %>%   st_as_sf(., coords = c("x", "y"), crs = 2056) -> re06
  
tmap_mode("view") 
tm_shape(re06) + tm_dots("month") +
tm_shape(wanderwege30) + tm_polygons(col = "popularity")  #split view?
  
```

## Results

### Overview

How many deer? What ar

### Movement on the Weekend

## Discussion

## Analysing trajectory data

Lets get time data etc

```{r}
pdf()
deer %>% 
  filter(steplength < 5000) %>% 
  ggplot(., aes(x= x, y = y, color = reh)) + 
  geom_path() + 
  geom_point() +
  coord_equal() 
dev.off()


```

Time plots

```{r}
ggplot(deer, aes(x = timelag)) +
  geom_bar() + scale_y_log10() + scale_x_log10() #2 groupings of timelag

deer %>% 
  filter(timelag < 2000) %>% 
  ggplot(., aes(x = timelag)) +
    geom_bar() + scale_y_log10() #solid amount under 500 seconds

ggplot(deer, aes(x=reh, y = timelag)) + geom_boxplot() #Reh 14 is an outlier?


deer %>% 
  filter(reh != "RE14") %>% 
  ggplot(., aes(x=reh, y = timelag)) + geom_boxplot() 

deer %>% 
  filter(reh != "RE14") %>% 
  summary(.)

```

It is clear that our average timelag is around 3 minutes - with some lower points dragging the mean down.

## Calculating speed

Now lets perform the trajectory analysis.

1 sample is taken every 3 hours. The question is do we really need to reduce the granularity

1 sample is taken ever 5 minutes so if we take a window of 30 minutes we use a window size of 6 positions

```{r}
deer_short %>% 
  filter(steplength < 3000) %>% 
  mutate(
    nMinus3 = sqrt((lag(y, 3)-y)^2 + (lag(x, 3)-x)^2),
    nMinus2 = sqrt((lag(y, 2)-y)^2+(lag(x, 2)-x)^2),  
    nMinus1 = sqrt((lag(y, 1)-y)^2+(lag(x, 1)-x)^2),
    nPlus1  = sqrt((y-lead(y, 1))^2+(x-lead(x, 1))^2), 
    nPlus2  = sqrt((y-lead(y, 2))^2+(x-lead(x, 2))^2),  
    nPlus3  = sqrt((y-lead(y, 3))^2+(x-lead(x, 3))^2)  
) %>% 
  rowwise(.) %>% 
  mutate(
    stepMean = mean(c(nMinus3, nMinus2, nMinus1, nPlus1, nPlus2, nPlus3))
  ) %>% 
  ungroup() %>% 
  mutate(static = stepMean < mean(stepMean, na.rm = TRUE)) -> deer_short
```

```{r eval=FALSE, include=FALSE}
ggplot(deer_short) + geom_boxplot(aes(y = stepMean), outlier.shape = NA) 

ggplot(deer_short) +
  geom_histogram(aes(x=stepMean), bins = 60) + geom_vline(xintercept = 4, color = "red")

summary(deer_short$stepMean)

ggplot(deer) +
  geom_line(aes(x=datetime_utc, y=stepMean)) 
```

```{r}
deer_short %>% 
  ggplot(data = ., aes(x = x, y = y)) +
    geom_point(aes(color = static)) +
    coord_fixed() + labs(title = "All static points removed")
```

```{r}
tmap_mode("view")

deer_short %>%
  mutate(segment_id = rle_id(static),
         duration = as.integer(difftime(max(datetime_utc),min(datetime_utc), units = "mins"))) %>% 
  filter(duration > 5) %>% 
  tm_shape(.) + tm_dots("segment_id") 
```

One idea: Create multiple buffers around hiking paths and see how much time is spent there.
